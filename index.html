
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Diapasón 12 trastes — Modos, Pentas y Menores (ortografía correcta por jónica madre)</title>
<style>
  :root{
    --bg:#1b1b1b;
    --wood-a:#9a6234;
    --wood-b:#70421d;
    --wood-hi:rgba(255,240,220,.06);
    --wood-lo:rgba(0,0,0,.08);
    --string:#d7d7d7;
    --cell-h:62px;
    --dot-size:36px;
    --maxw:1300px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    background:var(--bg); color:#ececec;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    display:flex; justify-content:center; padding:22px;
  }
  main{ width:100%; max-width:var(--maxw) }
  h1{ margin-bottom:12px; font-size:20px; font-weight:650; text-align:center }

  .fretboard{
    position:relative; overflow:hidden; border-radius:12px;
    background:
      linear-gradient(90deg, var(--wood-a), var(--wood-b)),
      repeating-linear-gradient(
        90deg,
        var(--wood-hi) 0 4px,
        transparent 4px 10px,
        var(--wood-lo) 10px 12px,
        transparent 12px 18px
      );
    background-blend-mode:multiply;
    box-shadow:0 8px 22px rgba(0,0,0,.5);
  }
  .cells{
    display:grid;
    grid-template-rows:repeat(6, var(--cell-h));
    grid-template-columns:
      100fr 97fr 94fr 91fr 88fr 85fr 82fr 79fr 76fr 73fr 70fr 67fr;
    position:relative; z-index:2;
  }
  .cell{
    position:relative;
    display:flex; align-items:center; justify-content:center;
    border-right:2px solid rgba(245,245,245,.65);
  }
  .cell:nth-child(12n+1){ border-left:3px solid rgba(245,245,245,.85) }

  .note{
    width:var(--dot-size); height:var(--dot-size);
    border-radius:50%;
    background:#fff; color:#000;
    font-weight:700; font-size:13px;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 2px 4px rgba(0,0,0,.40);
    z-index:5; user-select:none;
  }
  .tonic{ background:#c81e1e; color:#fff }
  .in-scale{ background:#1f6feb; color:#fff }

  .strings{
    pointer-events:none; position:absolute; inset:0; z-index:1;
  }
  .strings::before{
    content:""; position:absolute; left:0; right:0; top:0; bottom:0;
    background:
      linear-gradient(to right, var(--string), var(--string)) 0 calc(var(--cell-h)*0.5) / 100% 1.6px,
      linear-gradient(to right, var(--string), var(--string)) 0 calc(var(--cell-h)*1.5) / 100% 1.8px,
      linear-gradient(to right, var(--string), var(--string)) 0 calc(var(--cell-h)*2.5) / 100% 2px,
      linear-gradient(to right, var(--string), var(--string)) 0 calc(var(--cell-h)*3.5) / 100% 2.2px,
      linear-gradient(to right, var(--string), var(--string)) 0 calc(var(--cell-h)*4.5) / 100% 2.5px,
      linear-gradient(to right, var(--string), var(--string)) 0 calc(var(--cell-h)*5.5) / 100% 3px;
    background-repeat:no-repeat; opacity:.95;
    filter:drop-shadow(0 1px 0 rgba(0,0,0,.35));
  }

  .fret-numbers{
    margin-top:8px; display:grid;
    grid-template-columns:
      100fr 97fr 94fr 91fr 88fr 85fr 82fr 79fr 76fr 73fr 70fr 67fr;
    text-align:center;
  }
  .fret-numbers span{ font-size:14px; color:#f0f0f0; opacity:.95; user-select:none }

  .controls{ margin-top:20px; text-align:center }
  select, button{ font-size:14px; padding:6px 10px; margin:0 6px }
  button{
    background:#444; color:#fff; border:1px solid #777; border-radius:4px; cursor:pointer;
  }
  button:hover{ background:#666 }
</style>
</head>
<body>
<main>
  <h1>Diapasón (12 trastes) — Modos, Pentas y Menores (ortografía correcta)</h1>

  <div class="fretboard" id="fretboard">
    <div class="cells" id="cells"></div>
    <div class="strings" aria-hidden="true"></div>
  </div>
  <div class="fret-numbers" id="fretNumbers"></div>

  <div class="controls">
    <label>Tonalidad:
      <select id="keySelect">
        <!-- Orden círculo de 5tas mayores -->
        <option value="C">C</option>
        <option value="G">G</option>
        <option value="D">D</option>
        <option value="A">A</option>
        <option value="E">E</option>
        <option value="B">B</option>
        <option value="F#">F#</option>
        <option value="C#">C#</option>
        <option value="F">F</option>
        <option value="Bb">Bb</option>
        <option value="Eb">Eb</option>
        <option value="Ab">Ab</option>
        <option value="Db">Db</option>
        <option value="Gb">Gb</option>
        <option value="Cb">Cb</option>
      </select>
    </label>
    <label>Escala:
      <select id="scaleSelect">
        <!-- Modos de la mayor -->
        <option value="ionian">Jónico (Mayor)</option>
        <option value="dorian">Dórico</option>
        <option value="phrygian">Frigio</option>
        <option value="lydian">Lidio</option>
        <option value="mixolydian">Mixolidio</option>
        <option value="aeolian">Eólico (Menor natural)</option>
        <option value="locrian">Locrio</option>
        <!-- Pentas -->
        <option value="pentaMajor">Pentatónica Mayor</option>
        <option value="pentaMinor">Pentatónica Menor</option>
        <!-- Menores -->
        <option value="melodicMinor">Menor melódica</option>
        <option value="harmonicMinor">Menor armónica</option>
      </select>
    </label>
    <button id="applyBtn">Aplicar</button>
    <button id="resetBtn">Restablecer</button>
  </div>
</main>

<script>
  /* --- Cromas base y etiquetas por defecto --- */
  const SHARP   = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const FLAT    = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];
  const DISPLAY = ["C","C#/Db","D","D#/Eb","E","F","F#/Gb","G","G#/Ab","A","A#/Bb","B"];

  // Mapa nombre → índice (incluye B#, E#, Cb, Fb)
  const NAME_TO_INDEX = {
    "C":0, "B#":0,
    "C#":1,"Db":1,
    "D":2,
    "D#":3,"Eb":3,
    "E":4,"Fb":4,
    "F":5,"E#":5,
    "F#":6,"Gb":6,
    "G":7,
    "G#":8,"Ab":8,
    "A":9,
    "A#":10,"Bb":10,
    "B":11,"Cb":11
  };

  // Mayores válidas (como en tu selector)
  const VALID_MAJORS = new Set(["C","G","D","A","E","B","F#","C#","F","Bb","Eb","Ab","Db","Gb","Cb"]);

  // Excepciones de ortografía en mayores “difíciles”
  // idx: 5=F→E#, 0=C→B#, 11=B→Cb, 4=E→Fb
  const SPECIAL_NAMES_MAJOR = {
    "F#": { 5:"E#" },
    "C#": { 5:"E#", 0:"B#" },
    "Gb": { 11:"Cb" },
    "Cb": { 4:"Fb", 11:"Cb" }
  };

  // Para decidir la jónica madre de cada escala:
  // - Modos de la mayor: madre = raíz − [0,2,4,5,7,9,11] según el modo
  // - Penta mayor: madre = raíz
  // - Penta menor / melódica / armónica: madre = mayor relativa (raíz − 9)
  const PARENT_OFFSET_BY_SCALE = {
    ionian:        0,   // I
    dorian:        2,   // II
    phrygian:      4,   // III
    lydian:        5,   // IV
    mixolydian:    7,   // V
    aeolian:       9,   // VI
    locrian:       11,  // VII
    pentaMajor:    0,
    pentaMinor:    9,   // relativa mayor
    melodicMinor:  9,   // relativa mayor
    harmonicMinor: 9    // relativa mayor
  };

  function idxOf(name){ return NAME_TO_INDEX[name] ?? -1; }

  // Dado un índice de mayor, elige si esa madre debe escribirse en ♭ o ♯
  function preferFlatsForParentIdx(parentIdx, keyName){
    // Exclusivamente lado bemoles o naturales de familia de bemoles
    const FLAT_SIDE_STRICT = new Set([5,10,3,8]); // F, Bb, Eb, Ab
    const SHARP_SIDE_STRICT= new Set([7,2,9,4]);  // G, D, A, E

    if (FLAT_SIDE_STRICT.has(parentIdx)) return true;
    if (SHARP_SIDE_STRICT.has(parentIdx)) return false;

    // Ambiguos: 1 (C#/Db), 6 (F#/Gb), 11 (B/Cb)
    // Si la raíz pedida es bemol, fuerza bemoles; si es sostenido, fuerza sostenidos.
    if (/b/.test(keyName)) return true;
    if (/#/.test(keyName)) return false;

    // Si la raíz es natural y la jónica madre cae en índice ambiguo,
    // priorizamos bemoles para evitar A# en familias de ♭ (corrige tus casos reportados).
    return true;
  }

  // Devuelve el nombre de mayor válido (del selector) para un índice y la preferencia ♭/♯
  function majorNameForIndex(idx, preferFlats){
    const sharpName = SHARP[idx];
    const flatName  = FLAT[idx];
    const sharpValid = VALID_MAJORS.has(sharpName);
    const flatValid  = VALID_MAJORS.has(flatName);

    if (sharpValid && !flatValid) return sharpName;   // p.ej. C#
    if (flatValid  && !sharpValid) return flatName;   // p.ej. Eb
    if (sharpValid && flatValid)   return preferFlats ? flatName : sharpName; // C#/Db, F#/Gb, B/Cb
    return sharpName; // fallback
  }

  // ¿Esta mayor prefiere bemoles?
  function prefersFlatsMajorName(majorName){
    return ["F","Bb","Eb","Ab","Db","Gb","Cb"].includes(majorName);
  }

  // Nombre mostrado según la JÓNICA MADRE (aplica excepciones E#, B#, Cb, Fb)
  function nameForByParent(noteIdx, parentMajorName){
    if (SPECIAL_NAMES_MAJOR[parentMajorName] && SPECIAL_NAMES_MAJOR[parentMajorName][noteIdx]){
      return SPECIAL_NAMES_MAJOR[parentMajorName][noteIdx];
    }
    return prefersFlatsMajorName(parentMajorName) ? FLAT[noteIdx] : SHARP[noteIdx];
  }

  // Calcula la JÓNICA MADRE (nombre válido) de una escala dada (keyName, scaleId)
  function deriveParentMajorName(keyName, scaleId){
    const rootIdx = idxOf(keyName);
    const parentSemis = PARENT_OFFSET_BY_SCALE[scaleId] ?? 0;
    const parentIdx = (rootIdx - parentSemis + 12) % 12;

    const preferFlats = preferFlatsForParentIdx(parentIdx, keyName);
    return majorNameForIndex(parentIdx, preferFlats);
  }

  /* ---------- Patrones de escalas (semitonos desde la raíz pedida) ---------- */
  const SCALE_PATTERNS = {
    ionian:[0,2,4,5,7,9,11],
    dorian:[0,2,3,5,7,9,10],
    phrygian:[0,1,3,5,7,8,10],
    lydian:[0,2,4,6,7,9,11],
    mixolydian:[0,2,4,5,7,9,10],
    aeolian:[0,2,3,5,7,8,10],
    locrian:[0,1,3,5,6,8,10],
    pentaMajor:[0,2,4,7,9],
    pentaMinor:[0,3,5,7,10],
    melodicMinor:[0,2,3,5,7,9,11],
    harmonicMinor:[0,2,3,5,7,8,11]
  };

  /* ---------- Construcción del diapasón (todo visible) ---------- */
  const STRINGS_TOPDOWN = ["E","B","G","D","A","E"]; // 1ª arriba → 6ª abajo
  const FRETS = 12;

  const cells = document.getElementById("cells");
  const circles = [];
  for (let s=0; s<6; s++){
    const openIdx = idxOf(STRINGS_TOPDOWN[s]);
    for (let f=1; f<=FRETS; f++){
      const noteIdx = (openIdx + f) % 12;
      const cell = document.createElement("div"); cell.className="cell";
      const dot  = document.createElement("div"); dot.className="note";
      dot.textContent = DISPLAY[noteIdx];
      dot.dataset.noteIdx = noteIdx;
      cell.appendChild(dot); cells.appendChild(cell); circles.push(dot);
    }
  }
  const nums = document.getElementById("fretNumbers");
  for (let f=1; f<=FRETS; f++){ const span=document.createElement("span"); span.textContent=f; nums.appendChild(span); }

  /* ---------- Aplicar / Restablecer ---------- */
  function applyScale(keyName, scaleId){
    const pattern = SCALE_PATTERNS[scaleId]; if(!pattern) return;
    const rootIdx = idxOf(keyName); if(rootIdx<0) return;

    // 1) Determinar la JÓNICA MADRE de esta escala
    const parentMajorName = deriveParentMajorName(keyName, scaleId);

    // 2) Índices de la escala
    const inScale = new Set(pattern.map(semi => (rootIdx + semi) % 12));

    // 3) Pintar con ortografía de la jónica madre
    circles.forEach(dot=>{
      const ni = +dot.dataset.noteIdx;
      if (inScale.has(ni)){
        dot.style.display="flex";
        dot.textContent = nameForByParent(ni, parentMajorName);
        dot.classList.remove("tonic","in-scale");
        if (ni===rootIdx) dot.classList.add("tonic"); else dot.classList.add("in-scale");
      } else {
        dot.style.display="none";
        dot.classList.remove("tonic","in-scale");
      }
    });
  }

  function resetFretboard(){
    circles.forEach(dot=>{
      const ni=+dot.dataset.noteIdx;
      dot.style.display="flex";
      dot.textContent=DISPLAY[ni];
      dot.classList.remove("tonic","in-scale");
    });
  }

  document.getElementById("applyBtn").addEventListener("click", ()=>{
    const key   = document.getElementById("keySelect").value;
    const scale = document.getElementById("scaleSelect").value;
    applyScale(key, scale);
  });
  document.getElementById("resetBtn").addEventListener("click", resetFretboard);
</script>
</body>
</html>
